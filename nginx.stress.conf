worker_processes auto;

events {
  worker_connections 4096;
}

http {
  upstream taskcast_cluster {
    server taskcast1:3721;
    server taskcast2:3721;
    server taskcast3:3721;
    keepalive 64;
  }

  server {
    listen 80;
    access_log off;

    location / {
      proxy_pass         http://taskcast_cluster;
      proxy_http_version 1.1;

      # Required for upstream keepalive
      proxy_set_header   Connection "";
      proxy_set_header   Host $host;
      proxy_set_header   X-Real-IP $remote_addr;

      # SSE: must disable all buffering so chunks reach the client immediately
      proxy_buffering    off;
      proxy_cache        off;
      add_header         X-Accel-Buffering no always;

      # Long timeout for SSE connections (they stay open until task completes)
      proxy_read_timeout  300s;
      proxy_send_timeout  60s;

      # Allow large event payloads
      client_max_body_size 10m;
    }
  }
}
